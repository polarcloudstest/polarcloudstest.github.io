<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="prefer-datetime-locale" content="en-gb"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3" /><meta property="og:locale" content="en" /><meta name="description" content="Scripting for the Win… Or Should that be for the Failure?" /><meta property="og:description" content="Scripting for the Win… Or Should that be for the Failure?" /><link rel="canonical" href="/posts/esxi-rpi-ups-pt3/" /><meta property="og:url" content="/posts/esxi-rpi-ups-pt3/" /><meta property="og:site_name" content="PolarClouds" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-07-23T01:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3" /><meta name="twitter:site" content="@chall32" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-08-08T16:57:08+01:00","datePublished":"2022-07-23T01:00:00+01:00","description":"Scripting for the Win… Or Should that be for the Failure?","headline":"UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3","mainEntityOfPage":{"@type":"WebPage","@id":"/posts/esxi-rpi-ups-pt3/"},"url":"/posts/esxi-rpi-ups-pt3/"}</script><title>UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3 | PolarClouds</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="PolarClouds"><meta name="application-name" content="PolarClouds"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://polarclouds.co.uk/images/pages/ch200x200.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">PolarClouds</a></div><div class="site-subtitle font-italic">The personal blog of me, Chris Hall</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/chall32" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/chall32" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','domain.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1658534400" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jul 23, 2022 </em> </span> <span> Updated <em class="" data-ts="1659974228" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 8, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/chall32">Chris Hall</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1131 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><p><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3C/svg%3E" data-src="/images/esxi-rpi-ups-pt1/esxi-rpi-ups-pt1-00.png" alt="APC UPS Triggered shut down of ESXi from Raspberry Pi" width="200" height="200" style="max-width: 200px" class="right" data-proofer-ignore> <em>Sorry about the tardiness of this post. I had it written, lost it and then found it again…</em> <br /> <br /> Last <del>time</del> year we looked at our Uninterruptible Power Supply (UPS) hardware setup and the installation of the required software for our solution. If you’ve not seen that post, catch up now. It’s a great read. :wink:</p><p>As mentioned, this post is part 3 of a multipart series. Find the other parts here:</p><ul><li>Part 1: <a href="/posts/esxi-rpi-ups-pt1/" target="_blank">Hardware, Requirement, Software, Solution</a>)<li>Part 2: <a href="/posts/esxi-rpi-ups-pt2/" target="_blank">Hardware Connectivity and Software Installation</a>)<li>Part 3: This part - Scripting for the win… or should that be for the failure?</ul><p>First off a solution refresher of what we are trying to achieve in this series.</p><h2 id="solution-refresher"><span class="mr-2">Solution (Refresher)</span><a href="#solution-refresher" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><img data-src="/images/esxi-rpi-ups-pt1/esxi-rpi-ups-pt1-01.png" alt="The Solution" data-proofer-ignore></p><ol><li>Mains electricity fails… power cut!<li>The UPS signals to the Raspberry Pi that there is a power cut<li>The UPS signals its battery charge state to the Raspberry Pi<li>The UPS battery charge falls below a predetermined threshold and signals this to the Raspberry Pi<li>The Raspberry Pi runs a script to shut down all powered on VMs<li>The Raspberry Pi runs a script to shut down the ESXi host<li>The Raspberry Pi runs a script to shut itself down<li>The UPS stops supplying power from battery and shuts down which also shuts down the modem, router and network switch</ol><p>Let’s get to it.</p><h2 id="script-overview"><span class="mr-2">Script Overview</span><a href="#script-overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Lets look at what we need our script to achieve. Quite simple when we boil it down:</p><ol><li>Login to ESXi<li>Find and shutdown all powered on VMs<li>Shutdown ESXi server<li>Shutdown Raspberry Pi</ol><p>Simples!</p><p>First a couple of notes:</p><h2 id="powershell-credential-handling"><span class="mr-2">PowerShell Credential Handling</span><a href="#powershell-credential-handling" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As the PowerShell script will run in unattended mode, we need to find a method of storing ESXi credentials.</p><p>My least preferred option is to place the credentials into the script in clear text. My preferred method of using the Windows Credential Manager module (available <a href="https://www.powershellgallery.com/packages/CredentialManager/2.0" target="_blank">here</a>) unsurprisingly does not work when running PowerShell on Linux. Therefore we are going to have to go for a the middle of the road solution of storing the password as an encrypted string in a text file.</p><p>To do this, we simply need to run the following which will output our encrypted password to the file <code class="language-plaintext highlighter-rouge">/home/chris/cred.txt</code>:</p><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Credential</span><span class="w"> 
</span><span class="nv">$credential</span><span class="o">.</span><span class="nf">Password</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertFrom-SecureString</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Set-Content</span><span class="w"> </span><span class="nx">/home/chris/cred.txt</span></code></pre></figure><p>To “reconstitute” the password and combine with our user ID so that it can be used with the <code class="language-plaintext highlighter-rouge">Connect-VIServer -Credential</code> parameter, we need to include the following in our script:</p><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="nv">$Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"root"</span><span class="w">
</span><span class="nv">$Credfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/home/chris/cred.txt"</span><span class="w">
</span><span class="nv">$Encrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="nv">$Credfile</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w">
</span><span class="nv">$Credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PsCredential</span><span class="p">(</span><span class="nv">$Username</span><span class="p">,</span><span class="w"> </span><span class="nv">$Encrypted</span><span class="p">)</span></code></pre></figure><h2 id="telegram-alerting"><span class="mr-2">Telegram Alerting</span><a href="#telegram-alerting" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>One thing we’ve not touched on in this series yet is the need for notifications and alerting. It is always good to know what is going on with the UPS and the Raspberry Pi during a power cut.</p><p>In my solution script below, I’m going to use Telegram for notifications. Thinking here is that I will still receive the notifications during a power cut on my phone via 4 or 5G as at this point my non-UPS backed WiFi access points will also have had their power cut.</p><p>If you’ve not seen my post on sending Telegram messages from PowerShell, what are you waiting for? It’s simple. :wink:</p><p>Slight update to the Send-Telegram script to support Markdown formatting of messages:</p><figure><figcaption><b>Filename:</b>/home/chris/send-telegram2.ps1</figcaption><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c">#! /usr/bin/pwsh
</span><span class="w">
</span><span class="kr">Param</span><span class="p">(</span><span class="w">
</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="bp">$true</span><span class="p">)]</span><span class="nv">$Message</span><span class="p">,</span><span class="w">
</span><span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">Mandatory</span><span class="o">=</span><span class="bp">$false</span><span class="p">,</span><span class="n">HelpMessage</span><span class="o">=</span><span class="s2">"Specify Markdown or HTML formatting (Default = Markdown)"</span><span class="p">)][</span><span class="n">string</span><span class="p">]</span><span class="nv">$ParseMode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"Markdown"</span><span class="w">
</span><span class="p">)</span><span class="w">
</span><span class="nv">$Telegramtoken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;TELEGRAM TOKEN&gt;"</span><span class="w">
</span><span class="nv">$Telegramchatid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"&lt;TELEGRAM CHAT ID&gt;"</span><span class="w">
</span><span class="c"># ================================
</span><span class="w">
</span><span class="nv">$payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">@{</span><span class="w">
</span><span class="s2">"chat_id"</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="nv">$Telegramchatid</span><span class="p">;</span><span class="w">
</span><span class="s2">"text"</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="nv">$Message</span><span class="w">
</span><span class="s2">"parse_mode"</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$ParseMode</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># ================================
</span><span class="w">
</span><span class="p">[</span><span class="n">Net.ServicePointManager</span><span class="p">]::</span><span class="n">SecurityProtocol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Net.SecurityProtocolType</span><span class="p">]::</span><span class="n">Tls12</span><span class="w">
</span><span class="nv">$Response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Invoke-RestMethod</span><span class="w"> </span><span class="se">`
</span><span class="w">
</span><span class="nt">-Uri</span><span class="w"> </span><span class="p">(</span><span class="s2">"https://api.telegram.org/bot{0}/sendMessage"</span><span class="w"> </span><span class="nt">-f</span><span class="w"> </span><span class="nv">$Telegramtoken</span><span class="p">)</span><span class="w"> </span><span class="err">`</span><span class="w">
</span><span class="nt">-Method</span><span class="w"> </span><span class="n">Post</span><span class="w"> </span><span class="se">`
</span><span class="w">
</span><span class="nt">-ContentType</span><span class="w"> </span><span class="s2">"application/json"</span><span class="w"> </span><span class="err">`</span><span class="w">
</span><span class="nt">-Body</span><span class="w"> </span><span class="p">(</span><span class="n">ConvertTo-Json</span><span class="w"> </span><span class="nt">-Compress</span><span class="w"> </span><span class="nt">-InputObject</span><span class="w"> </span><span class="nv">$payload</span><span class="p">)</span><span class="w"> </span><span class="err">`</span><span class="w">
</span><span class="nt">-ErrorAction</span><span class="w"> </span><span class="n">Stop</span></code></pre></figure></figure><p>Don’t forget to mark the script executable using <code class="language-plaintext highlighter-rouge">chmod +x send-telegram2.ps1</code></p><h2 id="the-shut-down-script"><span class="mr-2">The Shut Down Script</span><a href="#the-shut-down-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Rather than post script snippets and talking about them for sections and sections, here is the complete script:</p><figure><figcaption><b>Filename:</b> /home/chris/shutdown.ps1</figcaption><figure class="highlight"><pre><code class="language-powershell" data-lang="powershell"><span class="c">#! /usr/bin/pwsh
</span><span class="w">
</span><span class="c"># == Complete These ==============
</span><span class="w">
</span><span class="nv">$ESXi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"esxi-server.local"</span><span class="w">
</span><span class="nv">$Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"root"</span><span class="w">
</span><span class="nv">$Credfile</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"/home/chris/cred.txt"</span><span class="w">
</span><span class="nv">$Waittime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"120"</span><span class="w"> 
</span><span class="c"># ================================
</span><span class="w">
</span><span class="kr">Function</span><span class="w"> </span><span class="nf">Send-Update</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="kr">Param</span><span class="p">(</span><span class="nv">$Message</span><span class="p">)</span><span class="w">
    </span><span class="nv">$time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">get-date</span><span class="w"> </span><span class="nt">-Format</span><span class="w"> </span><span class="s2">"dd/MM/yy HH:mm"</span><span class="p">)</span><span class="w">
    </span><span class="nv">$status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"*"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">$Message</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">"* - </span><span class="nv">$time</span><span class="s2">"</span><span class="w">
    </span><span class="n">/home/chris/send-telegram2</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="nv">$status</span><span class="w"> </span><span class="nt">-ParseMode</span><span class="w"> </span><span class="nx">Markdown</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="c"># ================================
</span><span class="w">
</span><span class="n">Import-Module</span><span class="w"> </span><span class="nx">VMware.PowerCLI</span><span class="w">
</span><span class="nv">$Encrypted</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-Content</span><span class="w"> </span><span class="s2">"</span><span class="nv">$Credfile</span><span class="s2">"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ConvertTo-SecureString</span><span class="w">
</span><span class="nv">$Credential</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-Object</span><span class="w"> </span><span class="nx">System.Management.Automation.PsCredential</span><span class="p">(</span><span class="nv">$Username</span><span class="p">,</span><span class="w"> </span><span class="nv">$Encrypted</span><span class="p">)</span><span class="w">
</span><span class="n">/home/chris/send-telegram2</span><span class="w"> </span><span class="nt">-Message</span><span class="w"> </span><span class="s2">"VM Shutdown Sequence Started. VMs to be Shutdown:"</span><span class="w"> </span><span class="nt">-ParseMode</span><span class="w"> </span><span class="nx">Markdown</span><span class="w">
</span><span class="n">Connect-VIServer</span><span class="w"> </span><span class="nv">$ESXi</span><span class="w"> </span><span class="nt">-Credential</span><span class="w"> </span><span class="nv">$Credential</span><span class="w">
</span><span class="nv">$PoweredVMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-VM</span><span class="p">)</span><span class="o">.</span><span class="nf">where</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">PowerState</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'PoweredOn'</span><span class="p">}</span><span class="w">
</span><span class="n">Send-Update</span><span class="w"> </span><span class="p">(</span><span class="nv">$PoweredVMs</span><span class="o">.</span><span class="nf">Name</span><span class="w"> </span><span class="o">|</span><span class="n">Out-String</span><span class="p">)</span><span class="w">

</span><span class="kr">ForEach</span><span class="w"> </span><span class="p">(</span><span class="nv">$VM</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$PoweredVMs</span><span class="p">){</span><span class="w">
    </span><span class="n">Send-Update</span><span class="w"> </span><span class="s2">"Shutting down </span><span class="nv">$VM</span><span class="s2">"</span><span class="w">
    </span><span class="nv">$VM</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Shutdown-VMGuest</span><span class="w"> </span><span class="nt">-Confirm</span><span class="p">:</span><span class="bp">$false</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="bp">$null</span><span class="w">
    </span><span class="nv">$looptime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$Waittime</span><span class="w">
    </span><span class="kr">do</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">sleep</span><span class="w"> </span><span class="nx">10</span><span class="w">
        </span><span class="nv">$looptime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$looptime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">10</span><span class="w">
     </span><span class="p">}</span><span class="w"> </span><span class="kr">until</span><span class="w"> </span><span class="p">((</span><span class="n">Get-VM</span><span class="w"> </span><span class="nv">$VM</span><span class="p">)</span><span class="o">.</span><span class="nf">PowerState</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'PoweredOff'</span><span class="w"> </span><span class="o">-or</span><span class="w"> </span><span class="nv">$looptime</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
     </span><span class="n">Send-Update</span><span class="w"> </span><span class="s2">"</span><span class="nv">$VM</span><span class="s2"> is </span><span class="si">$(</span><span class="p">(</span><span class="n">Get-VM</span><span class="w"> </span><span class="nv">$VM</span><span class="p">)</span><span class="o">.</span><span class="nf">PowerState</span><span class="si">)</span><span class="s2">"</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="nv">$KillVMs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">Get-VM</span><span class="p">)</span><span class="o">.</span><span class="nf">where</span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">PowerState</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'PoweredOn'</span><span class="p">}</span><span class="w">

</span><span class="kr">If</span><span class="w"> </span><span class="p">(</span><span class="nv">$KillVMs</span><span class="p">){</span><span class="w">
    </span><span class="kr">ForEach</span><span class="w"> </span><span class="p">(</span><span class="nv">$VM</span><span class="w"> </span><span class="kr">in</span><span class="w"> </span><span class="nv">$KillVMs</span><span class="p">){</span><span class="w">
        </span><span class="n">Send-Update</span><span class="w"> </span><span class="s2">"Killing </span><span class="nv">$VM</span><span class="s2">"</span><span class="w">
        </span><span class="n">Stop-VM</span><span class="w"> </span><span class="nt">-kill</span><span class="w"> </span><span class="nv">$VM</span><span class="w"> </span><span class="nt">-Confirm</span><span class="p">:</span><span class="bp">$false</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">Send-Update</span><span class="w"> </span><span class="s2">"Shutting down </span><span class="nv">$ESXi</span><span class="s2">"</span><span class="w">
</span><span class="n">Stop-VMHost</span><span class="w"> </span><span class="nv">$ESXi</span><span class="w"> </span><span class="nt">-Force</span><span class="w"> </span><span class="nt">-Confirm</span><span class="p">:</span><span class="bp">$false</span><span class="w">
</span><span class="n">Disconnect-VIServer</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nt">-confirm</span><span class="p">:</span><span class="bp">$false</span><span class="w">
</span><span class="n">Stop-Computer</span></code></pre></figure></figure><p>Don’t forget to mark the script executable using <code class="language-plaintext highlighter-rouge">chmod +x shutdown.ps1</code></p><h2 id="calling-the-powershell-shutdown-script"><span class="mr-2">Calling the PowerShell Shutdown Script</span><a href="#calling-the-powershell-shutdown-script" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Next we need to configure calling the above PowerShell script from the apcups daemon:</p><figure><figcaption><b>Filename:</b> /etc/apcupsd/doshutdown</figcaption><figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#!/bin/sh
</span>
<span class="c"># This shell script if placed in /etc/apcupsd will be called by /etc/apcupsd/apccontrol when the UPS is running on batteries 
</span>
<span class="c"># and one of the limits expires (time, run, load), this event is generated to cause the machine to shutdown.
</span>
<span class="nv">HOSTNAME</span><span class="o">=</span><span class="sb">`</span><span class="nb">hostname</span><span class="sb">`</span>
<span class="nv">MSG</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOSTNAME</span><span class="s2"> UPS </span><span class="nv">$1</span><span class="s2"> calling for controlled shut down"</span>

<span class="nv">now</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +<span class="s2">"%d/%m/%y %H:%M"</span><span class="si">)</span>
<span class="nv">now</span><span class="o">=</span><span class="s2">"</span><span class="nv">$now</span><span class="s2">"</span> pwsh <span class="nt">-file</span> /home/chris/send-telegram2.ps1 <span class="nt">-Message</span> <span class="s2">"&lt;b&gt;</span><span class="nv">$now</span><span class="s2">&lt;/b&gt; - UPS &lt;code&gt;</span><span class="k">${</span><span class="nv">1</span><span class="k">}</span><span class="s2">&lt;/code&gt; calling for control&gt;
pwsh -file /home/chris/shutdown.ps1
</span><span class="k">${</span><span class="nv">SHUTDOWN</span><span class="k">}</span><span class="s2"> -h now "</span>apcupsd UPS <span class="k">${</span><span class="nv">1</span><span class="k">}</span> initiated shutdown<span class="s2">"
#
(
   echo "</span><span class="nv">$MSG</span><span class="s2">"
   echo "</span> <span class="s2">"
   /sbin/apcaccess status
) | </span><span class="nv">$APCUPSD_MAIL</span><span class="s2"> -s "</span><span class="nv">$MSG</span><span class="s2">" </span><span class="nv">$SYSADMIN</span><span class="s2">
exit 0</span></code></pre></figure></figure><h2 id="testing"><span class="mr-2">Testing</span><a href="#testing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Remarking out the shutdown commands and adjusting the timeout to 10 seconds per loop:</p><div class="table-wrapper"><table><tr><td style="height:50%; width:50%;"> <a target="_blank" href="/images/esxi-rpi-ups-pt3/esxi-rpi-ups-pt3-01.jpg"><img style="display:block;" data-src="/images/esxi-rpi-ups-pt3/esxi-rpi-ups-pt3-01.jpg" alt="Telegram 1" data-proofer-ignore></a><td style="height:50%; width:50%;"> <a target="_blank" href="/images/esxi-rpi-ups-pt3/esxi-rpi-ups-pt3-02.jpg"><img style="display:block;" data-src="/images/esxi-rpi-ups-pt3/esxi-rpi-ups-pt3-02.jpg" alt="Telegram 2" data-proofer-ignore></a></table></div><p>Nice!</p><p>Of course <strong>PoweredOn</strong> will read <strong>PoweredOff</strong> when VMs are actually shutdown and there won’t be as much VM killing going on (second screenshot), but you get the idea.</p><h2 id="conclusion-and-wrap-up"><span class="mr-2">Conclusion and Wrap Up</span><a href="#conclusion-and-wrap-up" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There we have it: UPS initiated ESXi shutdown handled by a Raspberry Pi!</p><h3 id="bonus-rounds"><span class="mr-2">Bonus Rounds</span><a href="#bonus-rounds" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>There are several other event called scripts contained in <code class="language-plaintext highlighter-rouge">/etc/apcupsd/</code> that can be modified to provide UPS visibility. For example:</p><figure><figcaption><b>Filename:</b> /etc/apcupsd/onbattery</figcaption><figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#! /usr/bin/pwsh
</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="o">(</span>get-date <span class="nt">-Format</span> <span class="s2">"dd/MM/yy HH:mm"</span><span class="o">)</span>
<span class="nv">$status</span> <span class="o">=</span> <span class="s2">"*UPS Power failure - running on batteries!* - </span><span class="nv">$time</span><span class="s2">"</span>
/home/chris/send-telegram2 <span class="nt">-Message</span> <span class="nv">$status</span> <span class="nt">-ParseMode</span> Markdown</code></pre></figure></figure><figure><figcaption><b>Filename:</b> /etc/apcupsd/offbattery</figcaption><figure class="highlight"><pre><code class="language-shell" data-lang="shell"><span class="c">#! /usr/bin/pwsh
</span>
<span class="nv">$time</span> <span class="o">=</span> <span class="o">(</span>get-date <span class="nt">-Format</span> <span class="s2">"dd/MM/yy HH:mm"</span><span class="o">)</span>
<span class="nv">$status</span> <span class="o">=</span> <span class="s2">"*UPS Power returned - running on mains power* - </span><span class="nv">$time</span><span class="s2">"</span>
/home/chris/send-telegram2 <span class="nt">-Message</span> <span class="nv">$status</span> <span class="nt">-ParseMode</span> Markdown</code></pre></figure></figure><p>A full list of supported events can be found in <a href="http://www.apcupsd.org/manual/manual.html#customizing-event-handling" target="_blank">APCUPSD Manual - Customizing Event Handling</a>.</p><p>This post was <em>a belated</em> part 3 of a multipart series. Find the other parts here:</p><ul><li>Part 1: <a href="https://polarclouds.co.uk/esxi-rpi-ups-pt1" target="_blank">Hardware, Requirement, Software, Solution</a><li>Part 2: <a href="https://polarclouds.co.uk/esxi-rpi-ups-pt2" target="_blank">Hardware Connectivity and Software Installation</a><li>Part 3: This part - Scripting for the win… or should that be for the failure?</ul><p>-Chris</p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/pro-tip/" class="post-tag no-text-decoration" >Pro-Tip</a> <a href="/tags/vmware/" class="post-tag no-text-decoration" >VMware</a> <a href="/tags/deployment/" class="post-tag no-text-decoration" >Deployment</a> <a href="/tags/esxi/" class="post-tag no-text-decoration" >ESXi</a> <a href="/tags/linux/" class="post-tag no-text-decoration" >Linux</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=UPS+Triggered+Shut+Down+of+ESXi+from+Raspberry+Pi+-+Part+3+-+PolarClouds&url=%2Fposts%2Fesxi-rpi-ups-pt3%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=UPS+Triggered+Shut+Down+of+ESXi+from+Raspberry+Pi+-+Part+3+-+PolarClouds&u=%2Fposts%2Fesxi-rpi-ups-pt3%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fposts%2Fesxi-rpi-ups-pt3%2F&text=UPS+Triggered+Shut+Down+of+ESXi+from+Raspberry+Pi+-+Part+3+-+PolarClouds" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=%2Fposts%2Fesxi-rpi-ups-pt3%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="https://reddit.com/submit?url=%2Fposts%2Fesxi-rpi-ups-pt3%2F&title=UPS+Triggered+Shut+Down+of+ESXi+from+Raspberry+Pi+-+Part+3+-+PolarClouds" data-toggle="tooltip" data-placement="top" title="Reddit" target="_blank" rel="noopener" aria-label="Reddit"> <i class="fa-fw fab fa-reddit"></i> </a> <a href="http://service.weibo.com/share/share.php?title=UPS+Triggered+Shut+Down+of+ESXi+from+Raspberry+Pi+-+Part+3+-+PolarClouds&url=%2Fposts%2Fesxi-rpi-ups-pt3%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/vsphere-compliance-with-vro-pt2/">vSphere Compliance with vRealize Operations and Tagging - Part 2</a><li><a href="/posts/powershell-credential-handling/">PowerShell Credential Handling</a><li><a href="/posts/esxi-rpi-ups-pt1/">UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 1</a><li><a href="/posts/esxi-rpi-ups-pt2/">UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 2</a><li><a href="/posts/esxi-rpi-ups-pt3/">UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 3</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pro-tip/">Pro-Tip</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/esxi/">ESXi</a> <a class="post-tag" href="/tags/vmware/">VMware</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/vrealize/">vRealize</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/rubrik/">Rubrik</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/esxi-rpi-ups-pt1/"><div class="card-body"> <em class="small" data-ts="1618963200" data-df="ll" > Apr 21, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 1</h3><div class="text-muted small"><p> By the shear luck of being in the right place at the right time, I managed to get my hands on an APC Smart-UPS C1500 Uninterruptable Power Supply (UPS) for my home lab use. A UPS is a piece of ha...</p></div></div></a></div><div class="card"> <a href="/posts/esxi-rpi-ups-pt2/"><div class="card-body"> <em class="small" data-ts="1620086400" data-df="ll" > May 4, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>UPS Triggered Shut Down of ESXi from Raspberry Pi - Part 2</h3><div class="text-muted small"><p> Last time we looked at what needs to happen should we loose the input mains electricity supply to our newly acquired Uninterruptable Power Supply (UPS). For example during a power cut. We also go...</p></div></div></a></div><div class="card"> <a href="/posts/vsphere-compliance-with-vro/"><div class="card-body"> <em class="small" data-ts="1656374400" data-df="ll" > Jun 28, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>vSphere Compliance with vRealize Operations and Tagging</h3><div class="text-muted small"><p> In these days of anywhere computing, one of the tools in the arsenal of the good guys is system hardening. But what is system hardening? System hardening is defined as the practice of reducing a ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/vsphere-compliance-with-vro-pt2/" class="btn btn-outline-primary" prompt="Older"><p>vSphere Compliance with vRealize Operations and Tagging - Part 2</p></a> <a href="/posts/powershell-credential-handling/" class="btn btn-outline-primary" prompt="Newer"><p>PowerShell Credential Handling</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/chall32">Chris Hall</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/pro-tip/">Pro-Tip</a> <a class="post-tag" href="/tags/deployment/">Deployment</a> <a class="post-tag" href="/tags/esxi/">ESXi</a> <a class="post-tag" href="/tags/vmware/">VMware</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/vrealize/">vRealize</a> <a class="post-tag" href="/tags/powershell/">PowerShell</a> <a class="post-tag" href="/tags/rubrik/">Rubrik</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en-gb.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
